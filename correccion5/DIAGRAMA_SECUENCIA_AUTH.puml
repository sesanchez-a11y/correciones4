@startuml EduMentor_Sequence_Autenticacion
title EduMentor - Flujo de AutenticaciÃ³n (Secuencia)

participant "Cliente\n(Browser)" as CLIENT
participant "Frontend\n(JS)" as FRONTEND
participant "API\n(ASP.NET)" as API
participant "Repository\n(IUsuarioRepository)" as REPO
participant "MongoDB" as DB

== ðŸ“ REGISTRO ==
CLIENT -> FRONTEND: 1. Completa formulario registro
FRONTEND -> FRONTEND: 2. Valida campos (JS)
FRONTEND -> API: 3. POST /register\n{email, password, nombre, rol}
activate API
API -> REPO: 4. FindByEmailAsync(email)
activate REPO
REPO -> DB: Buscar usuario existente
DB --> REPO: No encontrado
REPO --> API: null
deactivate REPO

API -> API: 5. Crear Usuario (Estudiante/Tutor)
API -> API: 6. Hash BCrypt(password)
API -> REPO: 7. AddAsync(usuario)
activate REPO
REPO -> DB: Insert usuario
DB --> REPO: ObjectId
REPO --> API: userId
deactivate REPO

API -> API: 8. Generar JWT token
API --> FRONTEND: 9. {userId, token, user}
deactivate API

FRONTEND -> FRONTEND: 10. Guardar token en localStorage
FRONTEND -> FRONTEND: 11. Guardar user en localStorage
FRONTEND -> CLIENT: 12. Redirigir a perfil.html
CLIENT -> FRONTEND: 13. Cargar perfil.html

== ðŸ”‘ VALIDACIÃ“N DE SESIÃ“N ==
FRONTEND -> FRONTEND: 14. Leer token de localStorage
FRONTEND -> API: 15. GET /me\nHeader: Authorization: Bearer <token>
activate API
API -> API: 16. Validar JWT (middleware)
API -> API: 17. [Authorize] valida claims
API -> REPO: 18. FindByEmailAsync(email_del_token)
activate REPO
REPO -> DB: Buscar usuario
DB --> REPO: usuario encontrado
REPO --> API: Usuario
deactivate REPO

API --> FRONTEND: 19. {id, nombre, correo, rol}
deactivate API

FRONTEND -> FRONTEND: 20. Actualizar DOM\ncon datos del usuario
CLIENT -> CLIENT: 21. Mostrar perfil

== ðŸ”“ LOGIN ==
CLIENT -> FRONTEND: 1. Ingresa email y contraseÃ±a
FRONTEND -> FRONTEND: 2. Valida campos
FRONTEND -> API: 3. POST /login\n{email, password}
activate API
API -> REPO: 4. ValidateCredentialsAsync(email, pwd)
activate REPO
REPO -> DB: Buscar usuario
DB --> REPO: usuario (con hash)
REPO -> REPO: 5. Comparar BCrypt(pwd, hash)
REPO --> API: Usuario (si vÃ¡lido)
deactivate REPO

API -> API: 6. Generar JWT token
API --> FRONTEND: 7. {token, user}
deactivate API

FRONTEND -> FRONTEND: 8. Guardar token + user en localStorage
FRONTEND -> CLIENT: 9. Redirigir a perfil.html

== ðŸšª LOGOUT ==
CLIENT -> FRONTEND: 1. Click botÃ³n logout
FRONTEND -> FRONTEND: 2. Mostrar confirmaciÃ³n
CLIENT -> FRONTEND: 3. Confirma logout
FRONTEND -> FRONTEND: 4. Eliminar token de localStorage
FRONTEND -> FRONTEND: 5. Eliminar user de localStorage
FRONTEND -> CLIENT: 6. Redirigir a inicio.html

@enduml
