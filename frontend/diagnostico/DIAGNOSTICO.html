<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Perfil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; padding: 2rem; }
        .output { background: #1e1e1e; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 4px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>üîç Diagn√≥stico de Autenticaci√≥n y Perfil</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <h5>1. Estado Actual</h5>
                <button class="btn btn-primary me-2" id="checkBtn">Revisar Estado</button>
                <button class="btn btn-success me-2" id="tryPerfil">Ir a Perfil.html</button>
                <button class="btn btn-danger" id="clearBtn">Limpiar localStorage</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5>üìã Consola de Diagn√≥stico</h5>
            </div>
            <div class="card-body output" id="output"></div>
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const span = document.createElement('div');
            span.className = type;
            span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        document.getElementById('checkBtn').addEventListener('click', () => {
            log('=== DIAGN√ìSTICO INICIADO ===', 'info');
            
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            log(`Token: ${token ? '‚úì Existe (' + token.substring(0, 30) + '...)' : '‚úó No existe'}`, token ? 'success' : 'error');
            log(`CurrentUser: ${currentUser ? '‚úì Existe' : '‚úó No existe'}`, currentUser ? 'success' : 'error');
            
            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    log(`  Nombre: ${user.nombre} ${user.apellido}`, 'success');
                    log(`  Email: ${user.correo}`, 'success');
                    log(`  Rol: ${user.rol}`, 'success');
                } catch (e) {
                    log(`  ‚úó Error al parsear: ${e.message}`, 'error');
                }
            }
            
            if (token) {
                log('Probando /me endpoint...', 'info');
                fetch('http://localhost:5000/api/ControladorDeSesion/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
                .then(r => {
                    log(`  Respuesta: ${r.status} ${r.statusText}`, r.ok ? 'success' : 'error');
                    if (r.ok) return r.json();
                    throw new Error(`HTTP ${r.status}`);
                })
                .then(data => {
                    log(`  ‚úì /me devolvi√≥ datos:`, 'success');
                    log(`    ${data.nombre} ${data.apellido}`, 'success');
                    log(`    ${data.correo}`, 'success');
                })
                .catch(e => {
                    log(`  ‚úó Error: ${e.message}`, 'error');
                });
            }
        });

        document.getElementById('tryPerfil').addEventListener('click', () => {
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            if (!token && !currentUser) {
                log('‚ùå No hay sesi√≥n. Primero haz login en TEST_AUTH.html', 'error');
                return;
            }
            
            log('Redirigiendo a perfil.html...', 'info');
            window.location.href = 'carpeta/archivoshtml/perfil.html';
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            localStorage.clear();
            log('üóëÔ∏è localStorage limpiado', 'error');
        });

        log('‚úì P√°gina de diagn√≥stico cargada', 'success');
        log('Sigue los pasos para diagnosticar el problema', 'info');
    </script>
</body>
</html>
