<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        textarea { width: 100%; height: 300px; }
        button { padding: 10px 20px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Login EduMentor</h1>
    
    <div>
        <h2>1. Registrar Usuario</h2>
        <button onclick="testRegister()">Registrar: test2@test.com / 123456</button>
    </div>
    
    <div>
        <h2>2. Login</h2>
        <button onclick="testLogin()">Login: usuario@test.com / 123456</button>
    </div>
    
    <div>
        <h2>3. Obtener Perfil (Me)</h2>
        <button onclick="testMe()">Obtener /me</button>
    </div>
    
    <div>
        <h2>Respuesta:</h2>
        <textarea id="response" readonly></textarea>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api/ControladorDeSesion';
        
        function log(msg, isError = false) {
            const el = document.getElementById('response');
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : 'success';
            const prefix = isError ? '❌' : '✓';
            el.value += `[${timestamp}] ${prefix} ${msg}\n`;
            el.scrollTop = el.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('response').value = '';
        }
        
        async function testRegister() {
            clearLog();
            log('Iniciando registro...');
            
            const data = {
                Email: 'test2@test.com',
                Contrasena: '123456',
                Nombre: 'Test',
                Apellido: 'User',
                Edad: 25,
                Especializacion: 'Testing',
                Rol: 'Alumno'
            };
            
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    log('Registro exitoso: ' + JSON.stringify(result, null, 2));
                } else {
                    log('Error: ' + result.message, true);
                }
                log(`Status: ${response.status}`);
            } catch (err) {
                log('Error de red: ' + err.message, true);
            }
        }
        
        async function testLogin() {
            clearLog();
            log('Iniciando login...');
            
            const data = {
                Email: 'usuario@test.com',
                Password: '123456'
            };
            
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    log('Login exitoso!');
                    log('Token: ' + result.token.substring(0, 50) + '...');
                    log('Usuario: ' + JSON.stringify(result.user, null, 2));
                    
                    // Guardar en localStorage
                    localStorage.setItem('token', result.token);
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    log('✓ Token y usuario guardados en localStorage');
                } else {
                    log('Error: ' + result.message, true);
                }
                log(`Status: ${response.status}`);
            } catch (err) {
                log('Error de red: ' + err.message, true);
            }
        }
        
        async function testMe() {
            clearLog();
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('Error: No hay token guardado. Realiza login primero', true);
                return;
            }
            
            log('Obteniendo perfil con token...');
            log('Token guardado: ' + token.substring(0, 50) + '...');
            
            try {
                const response = await fetch(`${API_URL}/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (response.ok) {
                    log('✓ Perfil obtenido correctamente!');
                    log(JSON.stringify(result, null, 2));
                } else {
                    log('Error: ' + (result.message || response.statusText), true);
                }
                log(`Status: ${response.status}`);
            } catch (err) {
                log('Error de red: ' + err.message, true);
            }
        }
    </script>
</body>
</html>
