<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Perfil - EduMentor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f6f9;
            padding: 20px;
        }
        .log-container {
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            word-break: break-all;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #F5BE6B; }
        .info { color: #00aaff; }
        .section-title {
            color: #1264b6;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #1264b6;
            padding-bottom: 10px;
        }
        .status-badge {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
        }
        .status-ok { background-color: #28a745; color: white; }
        .status-error { background-color: #dc3545; color: white; }
        .status-warning { background-color: #F5BE6B; color: black; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Perfil - EduMentor</h1>
        <p class="text-muted">Esta p√°gina te ayudar√° a diagnosticar por qu√© la p√°gina de perfil se cierra despu√©s de iniciar sesi√≥n.</p>

        <div class="row">
            <div class="col-md-6">
                <h3 class="section-title">üìã Estado Actual</h3>
                <div id="statusDiv"></div>
            </div>
            <div class="col-md-6">
                <h3 class="section-title">üéÆ Controles</h3>
                <button class="btn btn-primary" onclick="checkLocalStorage()">1. Verificar localStorage</button>
                <button class="btn btn-info" onclick="testAPI()">2. Probar endpoint /me</button>
                <button class="btn btn-success" onclick="testLoadUserData()">3. Simular loadUserData()</button>
                <button class="btn btn-warning" onclick="clearAllData()">Limpiar localStorage</button>
                <button class="btn btn-danger" onclick="goToLogin()">Ir a login</button>
            </div>
        </div>

        <div class="section-title">üìä Consola de Diagn√≥stico</div>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        const logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('es-ES');
            logs.push({ timestamp, message, type });
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logs.map(log => 
                `<div class="log-entry ${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function checkLocalStorage() {
            addLog('=== VERIFICANDO LOCALSTORAGE ===', 'warning');
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            if (token) {
                addLog(`‚úì Token encontrado: ${token.substring(0, 30)}...`, 'success');
                // Validar que es un JWT v√°lido
                if (token.includes('.')) {
                    addLog('‚úì Token tiene formato JWT v√°lido (contiene puntos)', 'success');
                } else {
                    addLog('‚ö†Ô∏è Token NO parece ser JWT v√°lido', 'error');
                }
            } else {
                addLog('‚úó NO hay token en localStorage', 'error');
            }

            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    addLog(`‚úì currentUser encontrado:`, 'success');
                    addLog(`  - Nombre: ${user.nombre} ${user.apellido}`, 'info');
                    addLog(`  - Email: ${user.correo || user.email}`, 'info');
                    addLog(`  - Rol: ${user.rol}`, 'info');
                } catch (e) {
                    addLog(`‚úó Error parseando currentUser: ${e.message}`, 'error');
                }
            } else {
                addLog('‚úó NO hay currentUser en localStorage', 'error');
            }

            updateStatus();
        }

        async function testAPI() {
            addLog('=== PROBANDO ENDPOINT /me ===', 'warning');
            const token = localStorage.getItem('token');

            if (!token) {
                addLog('‚úó No hay token para probar /me', 'error');
                return;
            }

            try {
                addLog('Enviando GET /me con Bearer token...', 'info');
                const response = await fetch('http://localhost:5000/api/ControladorDeSesion/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                addLog(`Respuesta status: ${response.status}`, 'info');

                const data = await response.json();
                
                if (response.ok) {
                    addLog('‚úì /me respondi√≥ exitosamente', 'success');
                    addLog(`  - ID: ${data.id}`, 'info');
                    addLog(`  - Nombre: ${data.nombre} ${data.apellido}`, 'info');
                    addLog(`  - Email: ${data.correo}`, 'info');
                    addLog(`  - Rol: ${data.rol}`, 'info');
                } else {
                    addLog(`‚úó /me retorn√≥ error: ${response.status}`, 'error');
                    addLog(`Detalles: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                addLog(`‚úó Error de conexi√≥n: ${error.message}`, 'error');
                addLog('Verifica que el backend est√© corriendo en http://localhost:5000', 'warning');
            }
        }

        async function testLoadUserData() {
            addLog('=== SIMULANDO loadUserData() ===', 'warning');
            
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            addLog(`Token disponible: ${token ? 'S√≠' : 'No'}`, 'info');
            addLog(`CurrentUser disponible: ${currentUser ? 'S√≠' : 'No'}`, 'info');

            let user = null;

            // Intentar /me
            if (token) {
                try {
                    addLog('Intentando obtener datos de /me...', 'info');
                    const response = await fetch('http://localhost:5000/api/ControladorDeSesion/me', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        user = await response.json();
                        addLog('‚úì Datos obtenidos de /me', 'success');
                    } else {
                        addLog(`‚ö†Ô∏è /me fall√≥ con status ${response.status}`, 'warning');
                    }
                } catch (e) {
                    addLog(`‚ö†Ô∏è Error en /me: ${e.message}`, 'warning');
                }
            }

            // Fallback a currentUser
            if (!user && currentUser) {
                try {
                    user = JSON.parse(currentUser);
                    addLog('‚úì Usando datos de currentUser (localStorage)', 'success');
                } catch (e) {
                    addLog(`‚úó Error parseando currentUser: ${e.message}`, 'error');
                }
            }

            // Resultado final
            if (user) {
                addLog(`‚úì Usuario cargado: ${user.nombre} ${user.apellido}`, 'success');
                addLog('‚úì loadUserData() completar√≠a exitosamente', 'success');
            } else {
                addLog('‚úó Sin usuario disponible, redireccionar√≠a a login', 'error');
            }
        }

        function clearAllData() {
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            addLog('‚úì localStorage limpiado completamente', 'warning');
            updateStatus();
        }

        function goToLogin() {
            window.location.href = 'reseccion.html';
        }

        function updateStatus() {
            const token = localStorage.getItem('token');
            const currentUser = localStorage.getItem('currentUser');
            
            let html = '<h5>Estado de Sesi√≥n:</h5>';
            
            if (token && currentUser) {
                const user = JSON.parse(currentUser);
                html += `<span class="status-badge status-ok">‚úì Autenticado</span>`;
                html += `<br><br><strong>${user.nombre} ${user.apellido}</strong>`;
                html += `<br><small class="text-muted">${user.correo}</small>`;
                html += `<br><small class="badge bg-primary">${user.rol}</small>`;
            } else {
                html += `<span class="status-badge status-error">‚úó No Autenticado</span>`;
                html += `<br><br><small class="text-danger">Debes iniciar sesi√≥n primero</small>`;
            }

            document.getElementById('statusDiv').innerHTML = html;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ P√°gina de diagn√≥stico cargada', 'info');
            addLog('Presiona los botones para probar diferentes aspectos', 'info');
            updateStatus();
        });
    </script>
</body>
</html>
